/**
 * @class       Skii.ContextualMenu
 * @version     0.1
 * @author      Charles Demers - @charles_demers
 *
 * @requires    [core.js, jquery-1.5+]
 */

$(function(){var c=$('<div style="width:100px; height:100px; overflow:hidden; position:absolute; top:-999px; left:-999px;"><p style="border:width:50px; height:25px;"></p></div>'),d=c.find("p");$("body").append(c);var e=!!($.browser.msie&&$.browser.version<8);var b=(!e)?d.innerWidth():c.get(0).scrollWidth;c.css("overflow","auto");d.height(200);var a=(!e)?d.innerWidth():c.get(0).scrollWidth&&c.get(0).scrollWidth;c.remove();Skii.SCROLLBAR_WIDTH=b-a;});Skii.ContextualMenu=function(a){this.classPrefix="skii-contextualmenu";this.selectableOptionSelector="li:not(."+this.classPrefix+"-non-selectable)";this.keyDownThreshold=50;this.keyDownTimeout;this.keyDownRepeat=false;this.canSelect=true;this.selectionThreshold=300;this.currentOffsetX=0;this.currentOffsetY=0;this.initialWidth=0;this.totalWidth=0;this.totalHeight=0;this.shouldFitInViewport=(typeof a.shouldFitInViewport)?a.shouldFitInViewport:true;this.isFixed=(typeof a.isFixed=="boolean")?a.isFixed:true;this.canHaveScrollbar=a.canHaveScrollbar||false;this.canBeOnTop=a.canBeOnTop||false;this.isAnimated=a.isAnimated||false;this.isVisible=false;this.hasScrollbar=false;this.shouldUpdateOptionList=true;this.shouldUpdateBrowserMetrics=true;this.$selectedOption;this.lastFocusedElement;this.$list=$("<ul>",{"class":this.classPrefix,css:{width:a.width||"auto"}});this.$list.appendTo("body");this.rebuildOptions(a.options);this._$options=this.getSelectableOptions();$(Skii.ContextualMenu.Notifier).trigger("skii.contextualmenu.creation",[this]);};(function(){Skii.ContextualMenu.Notifier={instances:[],notify:function(){var c=Skii.ContextualMenu.Notifier.instances;for(var b=0,a=c.length;b<a;b++){c[b].shouldUpdateBrowserMetrics=true;}}};$(Skii.ContextualMenu.Notifier).bind("skii.contextualmenu.creation",function(b,a){Skii.ContextualMenu.Notifier.instances.push(a);});$(window).bind("resize",Skii.ContextualMenu.Notifier.notify);$(document).bind("scroll",Skii.ContextualMenu.Notifier.notify);})();Skii.ContextualMenu.prototype={_onKeyUp:function(b){if(this.isVisible){var a;switch(b.which){case Skii.KeyCodes.ENTER:case Skii.KeyCodes.SPACE:b.preventDefault();this.selectOption(b.currentTarget);break;case Skii.KeyCodes.ESCAPE:b.preventDefault();this.hide();break;case Skii.KeyCodes.ARROW_UP:case Skii.KeyCodes.ARROW_DOWN:b.preventDefault();clearTimeout(this.keyDownTimeout);this.keyDownRepeat=false;break;case Skii.KeyCodes.PAGE_UP:case Skii.KeyCodes.PAGE_DOWN:b.preventDefault();$(b.currentTarget).trigger("mouseout");a=(b.which==Skii.KeyCodes.PAGE_UP)?"first":"last";this.moveFocus(a);break;}}},_onKeyDown:function(a){switch(a.which){case Skii.KeyCodes.SPACE:case Skii.KeyCodes.TAB:case Skii.KeyCodes.ESCAPE:case Skii.KeyCodes.PAGE_UP:case Skii.KeyCodes.PAGE_DOWN:a.preventDefault();return false;break;case Skii.KeyCodes.ARROW_UP:case Skii.KeyCodes.ARROW_DOWN:a.preventDefault();var b=this;if(!this.keyDownRepeat){$(a.currentTarget).trigger("mouseout");if(!a.metaKey&&!a.altKey){direction=(a.which==Skii.KeyCodes.ARROW_UP)?"up":"down";}else{direction=(a.which==Skii.KeyCodes.ARROW_UP)?"first":"last";}this.moveFocus(direction,this.getSelectableOptions().index(a.currentTarget));}this.keyDownTimeout=setTimeout(function(){b.keyDownRepeat=true;$(a.currentTarget).trigger("mouseout");var c=(a.which==Skii.KeyCodes.ARROW_UP)?"up":"down";b.moveFocus(c,b.getSelectableOptions().index(a.currentTarget));},this.keyDownThreshold);break;}},_onOptionFocus:function(b){b.preventDefault();var a=$(b.currentTarget),c=$(this.getSelectableOptions()).filter("li.hover");a.attr("tabindex","0").focus();if(a.get(0)!=c.get(0)){a.addClass("hover");c.removeClass("hover").removeAttr("tabindex");}},_onOptionSelect:function(a){if(this.canSelect){a.preventDefault();if(this.isVisible){this.selectOption(a.currentTarget);}$(a.currentTarget).removeClass("hover");}},_cancelScroll:function(a){if(this.isVisible){a.preventDefault();}},getSelectableOptions:function(){if(this.shouldUpdateOptionList){this.shouldUpdateOptionList=false;this._$options=this.$list.find(this.selectableOptionSelector);}return this._$options;},focus:function(){this.lastFocusedElement=document.activeElement;if(!this.$selectedOption){this.$selectedOption=this.getSelectableOptions().first();}this.$selectedOption.trigger("mouseover");},blur:function(){if(this.$selectedOption){this.$selectedOption.blur();this.$selectedOption.removeAttr("tabindex","0");}$(this.lastFocusedElement).focus();},moveFocus:function(d,b){var a=this.getSelectableOptions();if(d=="up"||d=="down"){var c=b+((d=="up")?-1:1);if(c>=0&&c<a.length){$(a.get(c)).trigger("mouseover");}}else{if(d=="first"||d=="last"){a[d]().trigger("mouseover");}}},selectOption:function(b){b=$(b);if(b.length){var a=this.$list.find("li.selected");a.removeClass("selected");b.addClass("selected");this.$selectedOption=b;}$(this).trigger("skii.contextualmenu.selection",[b,this.getSelectableOptions().index(b),b.data("value")]);},enable:function(){this.$list.delegate(this.selectableOptionSelector,"mouseover",$.proxy(this,"_onOptionFocus"));this.$list.delegate(this.selectableOptionSelector,"mouseup",$.proxy(this,"_onOptionSelect"));this.$list.delegate(this.selectableOptionSelector,"keyup",$.proxy(this,"_onKeyUp"));this.$list.delegate(this.selectableOptionSelector,"keydown",$.proxy(this,"_onKeyDown"));$(window).bind("resize",$.proxy(this,"hide"));$(document).bind("scroll",$.proxy(this,"_cancelScroll"));},disable:function(){this.$list.undelegate(this.selectableOptionSelector,"mouseover",this._onOptionFocus);this.$list.undelegate(this.selectableOptionSelector,"click",this._onOptionSelect);this.$list.undelegate(this.selectableOptionSelector,"keyup",this._onKeyUp);this.$list.undelegate(this.selectableOptionSelector,"keydown",this._onKeyDown);$(window).unbind("resize",this.hide);$(document).unbind("scroll",this._cancelScroll);},rebuildOptions:function(a){var c=this;var b=function(e){var j=[];for(var g=0,d=e.length;g<d;g++){var k=e[g],h="",f="";for(var m in k){if((Skii.typeOf(k[m])=="string"||Skii.typeOf(k[m])=="number")&&m!="label"&&m!="selectable"){h="data-"+m+'="'+k[m]+'" ';}}if(k.selectable===false){f=c.classPrefix+"-non-selectable";}if(Skii.typeOf(k.value)=="array"){f+=" "+c.classPrefix+"-group";j.push('<li class="'+f+'" '+h+"><p>"+k.label+"</p><ul>");j.push(b(k.value));j.push("</ul></li>");}else{j.push('<li class="'+f+'" '+h+'><span class="'+c.classPrefix+'-check"></span>'+k.label+"</li>");}}return j.join("");};this.$list.html(b(a));this.initialWidth=this.$list.width();this.totalWidth=this.$list.outerWidth();this.totalHeight=this.$list.outerHeight();this.$selectedOption=null;this.shouldUpdateOptionList=true;},toggleVisibility:function(a){if(this.isVisible){this.hide();}else{this.show(a);}},show:function(a){var b=this;this.canSelect=false;this.updatePosition(a);if(!this.isAnimated){this.$list.css("display","block");}else{this.$list.fadeIn(150);}this.isVisible=true;this.enable();setTimeout(function(){b.canSelect=true;},this.selectionThreshold);},hide:function(){this.isVisible=false;this.disable();this.blur();if(!this.isAnimated){$(this.$list).css("display","none");}else{$(this.$list).fadeOut(150);}},updatePosition:function(e){if(this.shouldUpdateBrowserMetrics){this.shouldUpdateBrowserMetrics=false;var d=$(document),a=$(window);this.browserMetrics={docWidth:d.width(),docHeight:d.height(),viewportWidth:a.width(),viewportHeight:a.height(),scrollTop:d.scrollTop(),scrollLeft:d.scrollLeft()};}var b,c=this.browserMetrics;if(this.shouldFitInViewport||(c.docWidth<c.viewportWidth||c.docHeight<c.viewportHeight)){b={topLeft:{x:c.scrollLeft,y:c.scrollTop},bottomRight:{x:c.scrollLeft+c.viewportWidth,y:c.scrollTop+c.viewportHeight}};}else{b={topLeft:{x:0,y:0},bottomRight:{x:c.docWidth,y:c.docHeight}};}this.fitToBounds(e,b);},fitToBounds:function(f,a){var k={},c=15,h=(f&&f.x)||this.currentOffsetX,g=(f&&f.y)||this.currentOffsetY,i=this.$list,e=this.totalHeight,m=this.totalWidth,d=a.bottomRight.y-g-c,l=a.bottomRight.x-h-c,b=g-c,n=e<(a.bottomRight.y-a.topLeft.y)-(2*c),j=m<(a.bottomRight.x-a.topLeft.x)-(2*c);if(d>e){k.top=g;}else{if(this.canBeOnTop&&e<b){k.top=g-e;}else{if(!this.isFixed&&n){k.top=g-(e-d);}else{if(this.canHaveScrollbar&&d>(2*c)){k.top=g;k.height=d;}else{k.top=a.topLeft.y+15;k.height=(a.bottomRight.y-a.topLeft.y)-(2*c)-parseInt(this.$list.css("padding-top"),10)-parseInt(this.$list.css("padding-bottom"),10);}}}}k.left=(l>m)?h:h-m;this.$list.css(k);this.currentOffsetX=k.x;this.currentOffsetY=k.y;if(k.height){this.addScrollbar();}else{this.removeScrollbar();}},addScrollbar:function(){if(!this.hasScrollbar){this.hasScrollbar=true;this.$list.css({width:this.initialWidth+(Skii.SCROLLBAR_WIDTH),"overflow-y":"auto","overflow-x":"hidden"});}},removeScrollbar:function(){if(this.hasScrollbar){this.hasScrollbar=false;this.$list.css({width:this.initialWidth,height:"auto",overflowY:"hidden",overflowX:"hidden"});}}};